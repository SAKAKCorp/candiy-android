name: Notify Slack on PR
on:
  pull_request:
    types: [opened, reopened, edited]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3 # GitHub ì €ì¥ì†Œë¥¼ ì²´í¬ì•„ì›ƒí•˜ëŠ” ì•¡ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤

      - name: Get Reviewers List # ë¦¬ë·°ì–´ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
        id: reviewers # ì´ ë‹¨ê³„ì˜ IDë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        uses: actions/github-script@v6 # GitHub ìŠ¤í¬ë¦½íŠ¸ ì•¡ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with: # ì…ë ¥ìœ¼ë¡œ ì „ë‹¬í•  ê°’ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
          script: | # ë¦¬ë·°ì–´ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” JavaScript ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/workflows/users.json'));
            const requestedReviewers = context.payload.pull_request.requested_reviewers;
            if (!requestedReviewers || requestedReviewers.length === 0) {
              return "ë¦¬ë·°ì–´ë¥¼ ì§€ì •í•˜ì§€ ì•Šì•˜ì–´ìš”.";
            }
            const reviewers = requestedReviewers.map((user) => {
              const login = user.login;
              const mappedValue = workers[login];
              return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${login}`;
            });
            return `ë¦¬ë·°ì–´: ${reviewers.join(', ')}`;
          result-encoding: string # ê²°ê³¼ë¥¼ ë¬¸ìì—´ë¡œ ì¸ì½”ë”©í•©ë‹ˆë‹¤.

      - name: Get Author Slack ID # PR ì‘ì„±ìì˜ Slack IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
        id: author # ì´ ë‹¨ê³„ì˜ IDë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        uses: actions/github-script@v6 # GitHub ìŠ¤í¬ë¦½íŠ¸ ì•¡ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with: # ì…ë ¥ìœ¼ë¡œ ì „ë‹¬í•  ê°’ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
          script: | # PR ì‘ì„±ìì˜ Slack IDë¥¼ ê°€ì ¸ì˜¤ëŠ” JavaScript ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
            const fs = require('fs'); // íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë“ˆì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const workers = JSON.parse(fs.readFileSync('.github/workflows/users.json')); // .github/workflows/users.json íŒŒì¼ì„ ì½ì–´ì™€ JSON í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
            const authorLogin = context.payload.pull_request.user.login; // PR ì‘ì„±ìì˜ ë¡œê·¸ì¸ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const authorSlackId = workers[authorLogin]; // ì‘ì„±ìì˜ ë¡œê·¸ì¸ IDë¥¼ í‚¤ë¡œí•˜ì—¬ .github/workflows/user.json íŒŒì¼ì—ì„œ í•´ë‹¹í•˜ëŠ” ê°’(ìŠ¬ë™ ë©˜ì…˜ ID)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            return authorSlackId ? `<@${authorSlackId}>` : `No mapping found for ${authorLogin}`; // ë§Œì•½ ìŠ¬ë™ ë©˜ì…˜ IDê°€ ì¡´ì¬í•˜ë©´ ìŠ¬ë™ ë©˜ì…˜ ë¬¸ìì—´ì„ ë°˜í™˜í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 'No mapping found for'ì™€ ì‘ì„±ìì˜ ë¡œê·¸ì¸ IDë¥¼ í¬í•¨í•œ ë¬¸ìì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
          result-encoding: string # ê²°ê³¼ë¥¼ ë¬¸ìì—´ë¡œ ì¸ì½”ë”©í•©ë‹ˆë‹¤.

      - name: Send message to Slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            icon_emoji: ":meow_awauu:"
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ğŸ“ ${{
                    github.event.repository.name
                  }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":sparkles: *${{ github.event.pull_request.title }}*"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "ì‘ì„±ì: ${{ steps.author.outputs.result }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "${{ steps.reviewers.outputs.result }}"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "PR ë°”ë¡œê°€ê¸° ğŸš€"
                    url: "${{ github.event.pull_request.html_url }}"
                    style: "primary"
              - type: "divider"
